var APP_PREFIX='dynamic_gazo';var sendChromeMsg=(json,callback)=>{chrome.runtime.sendMessage(json,callback)};class ScreenShot{constructor(){this.CROP_BOX_SIZE=150;this.uiInit();this.positionLastRclick=[200,200];this.linkdata=null;this.tmp={'$contextMenuImg':[]};this.inlineViewer=null;this.app=null}renderCropper(boxParams=[]){var self=this;chrome.runtime.sendMessage({command:'get-scrapbox-list'},info=>{var scrapboxEnabled=info.scrapbox_enabled;var scrapboxIds=info.scrapbox_ids;if(scrapboxEnabled==='yes'&&scrapboxIds.length>0){var $select=$(`<select id="daiz-ss-cropper-scrap-select"></select>`);for(var i=0;i<scrapboxIds.length;i++){var scrapboxId=scrapboxIds[i];var $opt=$(`<option value="${scrapboxId}">${scrapboxId}</option>`);$select.append($opt)}self.setCropper(boxParams,$select)}else{self.setCropper(boxParams,null)}})}uiInit(){this.bindEvents()}$genCropper(){var $cropper=$(`<div class="daiz-ss-cropper" style="position: fixed;"></div>`);$cropper.css({top:0,left:0,width:this.CROP_BOX_SIZE,height:this.CROP_BOX_SIZE});return $cropper}fixHtml(fg){var fg=fg||false;if(fg){$('html').css({height:'100%',width:'100%',overflow:'hidden'})}else{$('html').css({height:'',width:'',overflow:'auto'})}}setCropper(boxParams=[],$scrapboxSelectBox=null){var $cropper=this.$genCropper();var closeBtnImg=chrome.extension.getURL('./image/x.png');var $closeBtn=$(`<div id="${APP_PREFIX}-daiz-ss-cropper-close" class="daiz-ss-cropper-close"></div>`);var $captureBtn=$(`<div id="${APP_PREFIX}-daiz-ss-cropper-capture"
            class="daiz-ss-cropper-capture">Capture</div>`);var $scrapboxBtn=$('<div id="daiz-ss-cropper-scrapbox">Scrap</div>');$closeBtn.css({'background-image':`url(${closeBtnImg})`});$cropper[0].className='daiz-ss-cropper-main';$cropper[0].id=`${APP_PREFIX}-daiz-ss-cropper-main`;if(boxParams.length===0){$cropper.css({left:this.positionLastRclick[0]-this.CROP_BOX_SIZE/2,top:this.positionLastRclick[1]-this.CROP_BOX_SIZE/2,width:this.CROP_BOX_SIZE,height:this.CROP_BOX_SIZE})}else{$cropper.css({left:boxParams[0],top:boxParams[1],width:boxParams[2],height:boxParams[3]})}$cropper.append($captureBtn);if($scrapboxSelectBox!==null){$cropper.append($scrapboxBtn);$cropper.append($scrapboxSelectBox)}$cropper.append($closeBtn);$cropper.draggable({stop:(ev,ui)=>{this._setRects()}});$cropper.resizable({stop:(ev,ui)=>{this._setRects()},handles:'all'});$('body').append($cropper);this._setRects()}_setRects(){var $cropper=$(`#${APP_PREFIX}-daiz-ss-cropper-main`);var rect=$cropper[0].getBoundingClientRect();if(rect===undefined)return;this.removeCropper();this.linkdata=this.setRects2(rect)}getSelectedText(){var self=this;var selection=window.getSelection();var text=selection.toString();return text}setRects2(croppedRect){console.log('###',croppedRect)}setRects(croppedRect){this.fixHtml(true);var text=this.getSelectedText();$('#daiz-ss-cropper-main').attr('title',text);var idx=0;var aTags=$('body').find('a');var aTagRects=[];for(var i=0;i<aTags.length;i++){var aTag=aTags[i];var rect=aTag.getBoundingClientRect();if(rect!==undefined){var fg=this.isInCroppedBox(rect,croppedRect);if(fg){var $cropper=this.$genCropper();$cropper.css({width:rect.width,height:rect.height,left:rect.left,top:rect.top});var aid='daiz-ss-a'+idx;var pos=this.correctPosition(rect,croppedRect);pos.id=aid;pos.href=$(aTag).prop('href');pos.text=$(aTag)[0].innerText;pos.fontSize=$(aTag).css('font-size');pos.fontFamily=$(aTag).css('font-family');$cropper.attr('title',$(aTag).attr('href'));$cropper.attr('id',aid);$('body').append($cropper);aTagRects.push(pos);idx+=1}}}var pos_cropper={x:0,y:0,orgX:croppedRect.left,orgY:croppedRect.top,width:croppedRect.width,height:croppedRect.height};var title=document.title||'';if(title.length===0){var embeds=$('embed');if(embeds.length>0&&embeds[0].type==='application/pdf'){var pdfPath='/'+embeds[0].src;var toks=pdfPath.split('/');title=toks[toks.length-1]}}var res={cropperRect:pos_cropper,aTagRects:aTagRects,text:text,winW:window.innerWidth,winH:window.innerHeight,baseUri:window.location.href,title:title};return res}isInCroppedBox(aTagRect,stageRect){var xa=stageRect.left;var xb=stageRect.left+stageRect.width;var ya=stageRect.top;var yb=stageRect.top+stageRect.height;var x1=aTagRect.left;var x2=aTagRect.left+aTagRect.width;var y1=aTagRect.top;var y2=aTagRect.top+aTagRect.height;var w=x2-x1;var h=y2-y1;var fgX=xa<=x1&&x2<=xb;var fgY=ya<=y1&&y2<=yb;if(fgX&&fgY&&w>=5&&h>=5){return true}return false}correctPosition(aTagRect,stageRect){var res={};var x1=aTagRect.left-stageRect.left;var x2=aTagRect.left+aTagRect.width-stageRect.left;var y1=aTagRect.top-stageRect.top;var y2=aTagRect.top+aTagRect.height-stageRect.top;res={x:x1,y:y1,width:aTagRect.width,height:aTagRect.height};return res}removeCropper(){$('.daiz-ss-cropper').remove()}removeCropperMain(){$('.daiz-ss-cropper-main').remove()}capture(mode='capture',scrapboxBoxId=''){var self=this;var res=[];window.getSelection().removeAllRanges();if(self.linkdata.aTagRects){for(var j=0;j<self.linkdata.aTagRects.length;j++){var aTagDatum=self.linkdata.aTagRects[j];var aid=aTagDatum.id;if($(`#${aid}`).length>0){res.push(aTagDatum)}}}self.linkdata.aTagRects=res;self.removeCropperMain();self.removeCropper();self.fixHtml(false);window.setTimeout(()=>{var rat=Math.max(window.devicePixelRatio,1);if(scrapboxBoxId.length===0)mode='capture';if(self.linkdata!==null){var appName=self.app;self.app=null;sendChromeMsg({command:'make-screen-shot',options:{sitedata:self.linkdata,mode:mode,scrapbox_box_id:scrapboxBoxId,app:appName,dpr:rat}})}},900)}bindEvents(){var self=this;var $body=$('body');$body.on('click','.daiz-ss-cropper',ev=>{$(ev.target).closest('.daiz-ss-cropper').remove()});$body.on('click',`#${APP_PREFIX}-daiz-ss-cropper-capture`,()=>{this.capture('capture')});$body.on('click','#daiz-ss-cropper-scrapbox',ev=>{var scrapboxBoxId=$('#daiz-ss-cropper-scrap-select').val()||'';this.capture('scrap',scrapboxBoxId)});$body.on('click',`#${APP_PREFIX}-daiz-ss-cropper-close`,ev=>{this.removeCropper();this.removeCropperMain();this.fixHtml(false)});$body.on('contextmenu','img',ev=>{var $img=$(ev.target).closest('img');this.tmp.$contextMenuImg=$img});$body.on('contextmenu','.card-thumbnail',ev=>{var $img=$(ev.target).closest('.card-area').find('.card-img');this.app='linkcard';self.tmp.$contextMenuImg=$img});$(window).bind('contextmenu',e=>{this.positionLastRclick=[e.clientX,e.clientY]});chrome.extension.onRequest.addListener((request,sender,sendResponse)=>{var re=request.event;if(re==='click-context-menu'){if(request.elementType==='image'||this.tmp.$contextMenuImg.length>0){var $img=this.tmp.$contextMenuImg;var imgRect=$img[0].getBoundingClientRect();this.tmp.$contextMenuImg=[];this.renderCropper([imgRect.left,imgRect.top,$img.width(),$img.height()])}else{this.renderCropper()}}else if(re==='make-card-scrapbox'){var themeImg=chrome.extension.getURL('.image/linkcard/scrapbox_default.png');var closeBtn=chrome.extension.getURL('./image/x.png');var $cardArea=$(`<div class="card-area"><img class="card-close" src="${closeBtn}"></div>`);var $img=$(`<img src="${themeImg}" class="card-img">`);var $title=$(`<div class="card-a"><a href="${window.location.href}">${document.title}</a></div>`);var $thumbnail=$(`<div class="card-thumbnail"></div>`);var ogImg=$('meta[property="og:image"]').attr('content');if(ogImg){$thumbnail.css({'background-color':'#fff','background-image':`url("${ogImg}")`})}else{$thumbnail.css('background-color','rgba(0, 0, 0, 0)')}$cardArea.append($img);$cardArea.append($title);$cardArea.append($thumbnail);$body.append($cardArea)}});$body.on('click','.card-close',ev=>{$('.card-area').remove()})}}var ss=new ScreenShot;chrome.extension.onRequest.addListener((request,sender,sendResponse)=>{var mark='chrome-ext';if(request.event==='updated-location-href'){var $body=$('body');if($body.length>0){$body[0].dataset.stat_daiz_svgss=mark}if(ss.inlineViewer===null){ss.inlineViewer=new InlineViewer}}});